{% extends "seller/chats_listing.html" %}
{% block chat_window %}
    <div class="col-md-12">
        <div class="chat-container">
            <div class="chat-header">
                <h1>Seller Chat <i class="fas fa-comment"></i></h1>
            </div>
            <div class="chat-logout">
                {% if request.user.is_authenticated %}
                <div style="float: left;font-weight: bold; color: #036358;">{{ request.user.first_name|title }} </div>
                <div style="clear: both;"></div>
                {% endif %}
            </div>
            <div class="chat__item__container" id="id_chat_item_container">
                {% for message in chats %}
                <div class="chat-message {% if message.sender == request.user %}right{% else %}left{% endif %}">
                    <div class="message-content">
                        <span class="message-username">{{ message.sender.username }}</span>
                        <span class="message-text">{{ message.message }}</span>
                        <span class="message-timestamp">{{ message.timestamp|date:"H:i" }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="chat-input-container">
                <input type="text" id="id_message_send_input" placeholder="Type your message..." />
                <button type="submit" id="id_message_send_button"><i class="fas fa-paper-plane"></i> Send</button>
            </div>
        </div>
        <script>
            const roomId = "{{ chat_room.id }}";
            const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
            const chatSocket = new WebSocket(protocol + window.location.host + "/ws/" + roomId + "/");
    
            chatSocket.onopen = function (e) {
                console.log("The connection was set up successfully!");
            };
            chatSocket.onclose = function (e) {
                console.log("Something unexpected happened!");
            };
    
            document.querySelector("#id_message_send_input").focus();
            document.querySelector("#id_message_send_input").onkeyup = function (e) {
                if (e.keyCode == 13) { // Enter key
                    document.querySelector("#id_message_send_button").click();
                }
            };
    
            document.querySelector("#id_message_send_button").onclick = function (e) {
                const messageInput = document.querySelector("#id_message_send_input").value;
    
                if (messageInput.trim() !== "") {
                    chatSocket.send(JSON.stringify({
                        message: messageInput,
                        username: "{{ request.user.username }}",
                    }));
                    document.querySelector("#id_message_send_input").value = "";
                }
            };
    
            chatSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                console.log("received from testing_seller", data.customer);
            
                const messageContainer = document.querySelector("#id_chat_item_container");
            
                const senderName = data.customer ? data.customer.charAt(0).toUpperCase() + data.customer.slice(1) : "Seller";
            
                const div = document.createElement("div");
                div.className = (data.customer === "{{ request.user.username }}") ? "chat-message right" : "chat-message left";
            
                div.innerHTML = `
                    <div class="message-content">
                        <span class="message-username">${senderName}</span>
                        <span class="message-text">${data.message}</span>
                    </div>`;
            
                messageContainer.appendChild(div);
            
                messageContainer.scrollTop = messageContainer.scrollHeight;
            };
        </script>
    </div>
{% endblock %}
